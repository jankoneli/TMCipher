<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMCipher Secure Channel</title>
    <style>
        body, html{
            background: black;
        }
        .msg{
            width: 90vw;
            background: rgb(33, 33, 33);
            border: none;
            outline: none;
            padding: 1rem;
            color: white;
            font-family: 'Courier New', Courier, monospace;
        }
        .messages p{
            font-family: 'Courier New', Courier, monospace;
            color: white;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <script src="/src/jquery.min.js"></script>
</head>
<body>
    <a href="/" style="font-family: 'Courier New', Courier, monospace;margin-bottom: 1rem;">Back to home</a>
    <input type="text" class="msg">
    <div class="messages">
        
    </div>
    <script>
        var passphrase = localStorage.getItem("passphrase")
        if (passphrase == null){
            open("/", "_self");
        }else{
            passphrase = passphrase.toString();
        }
        if ($(".msg").val() == "exit"){
            
        }
        localStorage.removeItem("passphrase");
        const socket = io();
        socket.on('abort', () => {
            alert("Display name already exists")
            open("/", "_self");

        });
        socket.on("message", (user, msg, hash, colorChat, salt) => {
            var key = CryptoJS.PBKDF2(passphrase, salt.toString(), {keySize: 512 / 32, iterations:10000})
            var plaintext = CryptoJS.AES.decrypt(msg, key.toString()).toString(CryptoJS.enc.Utf8)
            if(CryptoJS.SHA256(plaintext).toString() == hash){
                document.querySelector(".messages").innerHTML = '<p><span style="color: clr;margin-right: 2px;">user:</span>text</p>'.replace("clr", colorChat).replace("text", plaintext.replaceAll("<", "[REDACTED]").replaceAll(">", "[REDACTED]")).toString(CryptoJS.enc.Utf8).replace("user", user) + document.querySelector(".messages").innerHTML
            }
        })
        socket.emit("joinme", localStorage.getItem("channelid"), prompt("Enter Display Name: "))
        
        // Send message to server then back to channel
        $(".msg").keypress((e) => {
            if(e.which == 13){
                if (!$(".msg").val() == ""){
                    var salt = CryptoJS.lib.WordArray.random(128 / 8);
                    var hash = CryptoJS.SHA256($(".msg").val()).toString()
                    var key = CryptoJS.PBKDF2(passphrase, salt.toString(), {keySize: 512 / 32, iterations:10000})
                    var ciphertext = CryptoJS.AES.encrypt($(".msg").val(), key.toString()).toString()
                    socket.emit("msgchannel", ciphertext, localStorage.getItem("channelid"), hash, salt.toString())
                    $(".msg").val("")
                    return false;
                }
                
            }
        })
    </script>
</body>
</html>